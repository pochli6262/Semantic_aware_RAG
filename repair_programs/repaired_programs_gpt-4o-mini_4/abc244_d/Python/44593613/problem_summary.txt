The likely bug is that the recursive function does not account for the fact that after 10^18 operations all arrangements of hats can be achieved, leading to incorrect termination conditions.
