The likely bug is that the program checks for adjacency incorrectly by only looking in one direction (from A to B) instead of considering both A and B's horizontal neighbors.
