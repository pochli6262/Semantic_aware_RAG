The likely bug is that the code incorrectly checks for map equality using a function that does not properly handle the wrap-around positioning of the vertical and horizontal shifts after the shifts have been applied.
