The bug likely lies in the condition used to determine when to set the output for a leaf node, as it incorrectly checks if the node has been visited instead of confirming if it is actually a leaf node.
