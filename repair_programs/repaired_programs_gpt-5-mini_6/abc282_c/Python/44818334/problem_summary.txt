The program incorrectly replaces commas that are inside quoted segments rather than those outside because the parity check on the quote count is reversed.
