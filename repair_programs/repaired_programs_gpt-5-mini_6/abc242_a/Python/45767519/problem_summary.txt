The conditional for the random-selection case wrongly tests "X <= C" instead of "X <= B", so ranks between A+1 and B are not handled correctly.
